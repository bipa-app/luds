LUD-23: Cost callback in `payRequest`.
=================================

`author: lsunsi`
`author: luizParreira`
`author: lorenzolfm`

---

## Support for LNURL-pay currencies

This document describes an extension to the [payRequest](https://github.com/lnurl/luds/blob/luds/06.md) and [currencies](https://github.com/lnurl/luds/blob/luds/21.md) specification that allows the `WALLET` to inform a `SERVICE` about the cost of the BTC being paid. The `cost` information is denominated in any currency and provides the `SERVICE` enough information to provide a richer visualization for the user, especially when paired with features described in the [currencies](https://github.com/lnurl/luds/blob/luds/21.md) extension.

The main features provided by this extension are:
- `SERVICE` **MUST** provide `WALLET` a `cost` callback URL
- `WALLET` **MAY** use the callback URL to inform the `SERVICE` about the cost of the BTC being paid

### Service-side callback response

Every request up until the callback response is unchanged from other specs.

`SERVICE` **must** return an extra `cost` field on the callback, alongside all other properties. The field must contain a URL that the `WALLET` can call providing information about the `cost`.

```typescript
type BaseResponse = {
  pr: string,
  routes: [],
}

type ExtendedResponse = BaseResponse & {
  cost: string,
}
```

```diff
{
  "pr": "lnbc1230n1pjknkl...ju36m3lyytlwv42fee8gpt6vd2v",
  "routes": [],
+ "cost": "https://bipa.app/..."
}
```

### Wallet-side cost callback request

`WALLET` **may** call the provided URL with a `POST` method and specific body including information about the currency and amount used to buy the BTC used on the payment. Upon receiving this request, the `SERVICE` **may** use it to display richer information to the user about the BTC it just received. The body of the request is as follows.

```typescript
type Body = {
  code: string, // Code of the currency, used as an ID for it. E.g.: BRL
  name: string, // Name of the currency. E.g.: Reais
  symbol: string, // Symbol of the currency. E.g.: R$
  decimals: number, // Integer; Number of decimal places. E.g.: 2
  amount: number, // Integer; Amount denominated in currency smallest unit, according to decimals
}
```
```json5
// Example
{
  "code": "BRL",
  "name": "Reais",
  "symbol": "R$",
  "decimals": 2,
  "amount": 100
}
```

### Service-side cost callback response

`SERVICE` **must** return the usual OK-or-ERROR JSON structures informing about the success or failure of the operation.

```json5
{"status": "OK"} /* or */ {"status": "ERROR", "reason": "error details..."}
```

## Notes on interoperability with LUD-21

This extension does not require LUD-21, but implementors of it are highly recommended to implement both.

The full utilization of both of these extensions allows a foreign user to deposit fiat to a local service, denominate a payment to a foreign service in its local currency, know beforehand the fiat-to-fiat conversion rates, and perform a lightning-fast payment that encompasses both the BTC buying and selling, all in one operation.

After the fact, both services (local and foreign) will be able to show rich information about the operation to the user, including the properly formatted local and foreign currencies and the conversion rates.
